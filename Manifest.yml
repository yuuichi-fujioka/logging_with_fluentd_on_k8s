apiVersion: v1
kind: ConfigMap
metadata:
  name: td-server-conf
data:
  td-agent.conf: |
    <source>
        @type forward
    </source>
    
    <match **>
      @type copy

      <store>
        @type stdout
      </store>

      <store>
        @type file
        path /var/log/fluentd/out
        time_slice_format %Y%m%d
        time_slice_wait 10m
        time_format %Y%m%dT%H%M%S%z
        utc
      </store>
    </match>
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: fluentd-server
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: fluentd-server
    spec:
      containers:
      - name: fluentd-server
        image: fluent/fluentd:v1.1
        ports:
        - containerPort: 24224
        volumeMounts:
        - mountPath: /fluentd/etc
          name: td-server-conf
        - mountPath: /var/log/fluentd
          name: logs
        env:
        - name: FLUENTD_CONF
          value: td-agent.conf
      volumes:
      - name: td-server-conf
        configMap:
          name: td-server-conf
      - name: logs
        persistentVolumeClaim:
          claimName: fluentd-logs
---
kind: Service
apiVersion: v1
metadata:
  name: fluentd-server
spec:
  selector:
    app: fluentd-server
  ports:
  - protocol: TCP
    port: 24224
    targetPort: 24224
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: td-agent-conf
data:
  td-agent.conf: |

    <source>
      @type tail
      path /log/**/*.log
      pos_file /var/log/fluentd/others.pos
      format none

      tag "log.#{ENV['NODE_NAME']}.*"
    </source>

    <source>
      @type tail
      path /log/syslog
      format syslog
      pos_file /var/log/fluentd/syslog.pos

      tag "log.#{ENV['NODE_NAME']}.*"
    </source>

    <match log.**>
      @type copy

      <store>
        @type stdout
      </store>

      <store>
        @type forward
        send_timeout 60s
        recover_wait 10s
        hard_timeout 60s
        flush_interval 1
        retry_limit 10

        <server>
          host fluentd-server
          port 24224
        </server>
      </store>

    </match>
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: td-agent
spec:
  template:
    metadata:
      labels:
        app: td-agent
      name: td-agent
    spec:
      containers:
      - image: fluent/fluentd:v1.1
        name: td-agent
        volumeMounts:
        - mountPath: /log
          name: host-log
          readOnly: yes
        - mountPath: /fluentd/etc
          name: td-agent-conf
        - mountPath: /var/log/fluentd
          name: logs
        env:
        - name: FLUENTD_CONF
          value: td-agent.conf
        - name: FLUENT_UID
          value: "0"
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
      volumes:
      - name: host-log
        hostPath:
          path: /var/log
          type: Directory
      - name: td-agent-conf
        configMap:
          name: td-agent-conf
      - name: logs
        emptyDir: {}
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

